{% extends 'layout.html' %}
{% load humanize %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="max-w-5xl mx-auto px-4 py-10">
    <div class="mb-8">
        <div class="flex justify-between items-start gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <p class="text-orange-600 font-bold uppercase tracking-widest text-sm">{{ event.category.name }}</p>
                    
                    {% now "Y-m-d H:i" as current_time %}
                    {% if event.end_date and event.end_date|date:"Y-m-d H:i" < current_time %}
                        <span class="px-3 py-0.5 bg-gray-100 text-gray-600 text-xs font-bold rounded-full uppercase">Ended</span>
                    {% elif event.start_date|date:"Y-m-d H:i" <= current_time %}
                        <span class="px-3 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full uppercase animate-pulse flex items-center">
                            <span class="w-2 h-2 bg-green-600 rounded-full mr-1.5"></span> Live Now
                        </span>
                    {% else %}
                        <span class="px-3 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded-full uppercase">Upcoming</span>
                    {% endif %}
                </div>
                <h1 class="text-4xl font-extrabold text-gray-900 mt-2">{{ event.title }}</h1>
                <p class="text-gray-500 mt-2 font-medium">
                    by <span class="text-orange-600 font-bold">{{ event.organizer.get_full_name|default:event.organizer.username }}</span>
                </p>
            </div>

            <button onclick="toggleInterest(this, {{ event.id }})" 
                    class="interest-btn flex items-center gap-2 px-6 py-3 rounded-2xl transition-all duration-300 border-2 
                    {% if request.user.id in event.interested_users_list %} 
                        bg-orange-600 border-orange-600 text-white shadow-lg shadow-orange-100 
                    {% else %} 
                        bg-white border-orange-100 text-orange-600 hover:bg-orange-50 
                    {% endif %}">
                <i class="bi {% if request.user.id in event.interested_users_list %}bi-check-circle-fill{% else %}bi-plus-lg{% endif %}"></i>
                <span class="font-bold">Interested</span>
                <span class="bg-black/10 px-2 py-0.5 rounded-lg text-xs interest-count">{{ event.interested_users.count }}</span>
            </button>
        </div>
        
        <div class="flex flex-wrap items-center text-gray-500 mt-4 gap-6">
            <span><i class="bi bi-calendar3 mr-1 text-orange-600"></i> {{ event.start_date|date:"M d, Y @ P" }}</span>
            <span><i class="bi bi-geo-alt mr-1 text-orange-600"></i> {{ event.address }}</span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        <div class="lg:col-span-2 space-y-8">
            {% if event.banner_image %}
                <img src="{{ event.banner_image.url }}" class="w-full h-96 object-cover rounded-3xl shadow-lg border border-gray-100">
            {% endif %}
            
            <div class="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm">
                <h2 class="text-2xl font-bold mb-4">About this Event</h2>
                <div class="text-gray-600 leading-relaxed whitespace-pre-line">
                    {{ event.description }}
                </div>
            </div>

            <div class="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-gradient-to-br from-orange-100 to-orange-50 rounded-2xl flex items-center justify-center text-orange-600 shadow-inner">
                        <i class="bi bi-person-vcard text-3xl"></i>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-[0.2em] mb-1">Organized By</p>
                        <h4 class="text-xl font-bold text-gray-900 leading-tight">
                            {{ event.organizer.get_full_name|default:event.organizer.username }}
                        </h4>
                        <p class="text-sm text-gray-500">Official Event-Sathi Host</p>
                    </div>
                </div>

                <div class="flex gap-3 w-full md:w-auto">
                    <a href="mailto:{{ event.organizer.email }}" 
                       class="flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-3 bg-gray-900 text-white rounded-xl font-bold text-sm hover:bg-black transition shadow-lg shadow-gray-200">
                        <i class="bi bi-envelope-fill"></i> Contact
                    </a>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white p-6 rounded-3xl border border-orange-100 shadow-xl sticky top-24">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-gray-500 font-medium">Ticket Price</span>
                    <span class="text-3xl font-black text-orange-600">
                        {% if event.ticket_price > 0 %}
                            Rs. {{ event.ticket_price|intcomma }}
                        {% else %}
                            FREE
                        {% endif %}
                    </span>
                </div>
                
                {% if event.ticket_price > 0 %}
                    <a href="{% url 'payment_options' event.id %}" 
                       class="block w-full text-center bg-orange-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-orange-700 transition mb-4 shadow-lg shadow-orange-200">
                        Buy Ticket
                    </a>
                {% else %}
                    <div class="bg-green-50 text-green-700 p-4 rounded-2xl text-center font-semibold border border-green-100 mb-4">
                        Entry is Free - Just Join Us!
                    </div>
                {% endif %}
                
                <hr class="my-6 border-gray-100">
                
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 text-lg">Location</h3>
                    <a href="https://www.google.com/maps?q={{ event.latitude }},{{ event.longitude }}" 
                       target="_blank" 
                       class="text-sm text-orange-600 font-bold hover:underline flex items-center">
                        Open Maps <i class="bi bi-box-arrow-up-right ml-1"></i>
                    </a>
                </div>

                <div id="detail-map" class="h-48 w-full rounded-2xl border border-gray-100 shadow-inner overflow-hidden mb-4" style="z-index: 1;"></div>
                
                <a href="https://www.google.com/maps?q={{ event.latitude }},{{ event.longitude }}" 
                   target="_blank" 
                   class="flex items-center justify-center w-full bg-gray-50 border border-gray-200 text-gray-700 py-3 rounded-xl font-bold text-sm hover:bg-gray-100 transition">
                    <i class="bi bi-google mr-2 text-red-500"></i> Get Directions
                </a>

                <div class="mt-6 pt-6 border-t border-gray-50 text-center">
                    <a href="#" class="text-xs text-gray-400 hover:text-red-500 transition font-medium">
                        <i class="bi bi-flag-fill mr-1"></i> Report this event
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const lat = parseFloat("{{ event.latitude|default:27.7172 }}");
    const lng = parseFloat("{{ event.longitude|default:85.3240 }}");

    const map = L.map('detail-map', {
        scrollWheelZoom: false,
        dragging: !L.Browser.mobile,
        tap: !L.Browser.mobile
    }).setView([lat, lng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    L.marker([lat, lng]).addTo(map)
        .bindPopup("<strong>{{ event.title }}</strong>")
        .openPopup();
});

function toggleInterest(btn, eventId) {
    {% if not user.is_authenticated %}
        window.location.href = "{% url 'login' %}";
        return;
    {% endif %}

    fetch(`/toggle-interest/${eventId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        const icon = btn.querySelector('i');
        const countSpan = btn.querySelector('.interest-count');
        countSpan.innerText = data.count;

        if (data.is_interested) {
            btn.classList.replace('bg-white', 'bg-orange-600');
            btn.classList.replace('text-orange-600', 'text-white');
            btn.classList.replace('border-orange-100', 'border-orange-600');
            icon.classList.replace('bi-plus-lg', 'bi-check-circle-fill');
        } else {
            btn.classList.replace('bg-orange-600', 'bg-white');
            btn.classList.replace('text-white', 'text-orange-600');
            btn.classList.replace('border-orange-600', 'border-orange-100');
            icon.classList.replace('bi-check-circle-fill', 'bi-plus-lg');
        }
    });
}
</script>
{% endblock %}